# åŠ¨åŠ›å­¦å‚æ•°è¾¨è¯†å®ç°æ€»ç»“

## ğŸ¯ å®ç°ç›®æ ‡

ä¸¥æ ¼æŒ‰ç…§ `shamilmamedov/dynamic_calibration` çš„é€»è¾‘å®ç°å®Œæ•´çš„åŠ¨åŠ›å­¦å‚æ•°è¾¨è¯†æµç¨‹ã€‚

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. Step 1: æ•°æ®é¢„å¤„ç† (`step1_data_preprocessing.py`)

**å¯¹åº”åŸé¡¹ç›®:** `filterData.m`

**å®ç°çš„æ ¸å¿ƒåŠŸèƒ½:**

| åŠŸèƒ½ | åŸé¡¹ç›® (MATLAB) | æœ¬å®ç° (Python) | çŠ¶æ€ |
|------|----------------|----------------|------|
| é›¶ç›¸ä½æ»¤æ³¢ | `filtfilt()` | `scipy.signal.filtfilt()` | âœ… |
| ä¸­å¿ƒå·®åˆ†æ³•ä¼°è®¡åŠ é€Ÿåº¦ | æ‰‹åŠ¨å®ç° | `estimate_acceleration_central_diff()` | âœ… |
| Butterworth ä½é€šæ»¤æ³¢å™¨ | `butter()` | `scipy.signal.butter()` | âœ… |
| ä½ç½®æ»¤æ³¢ | å¯é€‰ | å¯é€‰ (`filter_position=True`) | âœ… |
| é€Ÿåº¦æ»¤æ³¢ | å¯é€‰ | å¯é€‰ (`filter_velocity=True`) | âœ… |
| åŠ›çŸ©æ»¤æ³¢ | å¿…é¡» | å¿…é¡» (`filter_torque=True`) | âœ… |
| åŠ é€Ÿåº¦æ»¤æ³¢ | å¿…é¡» | å¿…é¡» (`filter_acceleration=True`) | âœ… |

**å…³é”®å®ç°ç»†èŠ‚:**

```python
# é›¶ç›¸ä½æ»¤æ³¢ - é¿å…ç›¸ä½å»¶è¿Ÿ
filtered_data = filtfilt(b, a, data)

# ä¸­å¿ƒå·®åˆ†æ³• - æ›´å‡†ç¡®çš„åŠ é€Ÿåº¦ä¼°è®¡
acc[i] = (vel[i+1] - vel[i-1]) / (2*dt)

# è¾¹ç•Œå¤„ç†
acc[0] = (vel[1] - vel[0]) / dt
acc[-1] = (vel[-1] - vel[-2]) / dt
```

---

### 2. Step 2: å‚æ•°ä¼°è®¡ (`step2_parameter_estimation.py`)

**å¯¹åº”åŸé¡¹ç›®:** `ordinaryLeastSquareEstimation` in `ur_idntfcn_real.m`

**å®ç°çš„æ ¸å¿ƒåŠŸèƒ½:**

| åŠŸèƒ½ | åŸé¡¹ç›® (MATLAB) | æœ¬å®ç° (Python) | çŠ¶æ€ |
|------|----------------|----------------|------|
| æ„å»ºå›å½’çŸ©é˜µ | `buildRegressorMatrix()` | `build_regressor_matrix()` | âœ… |
| æ™®é€šæœ€å°äºŒä¹˜ | `Î¸ = (Y'*Y)\(Y'*Ï„)` | `scipy.linalg.lstsq()` | âœ… |
| æ¡ä»¶æ•°æ£€æŸ¥ | `cond(Y)` | `np.linalg.cond(Y)` | âœ… |
| é¢„æµ‹åŠ›çŸ© | `Ï„_pred = Y * Î¸` | `predict_torque()` | âœ… |
| æ€§èƒ½è¯„ä¼° | RMSE, RÂ² | RMSE, MAE, RÂ², Max Error | âœ… |

**æ•°å­¦æ¨¡å‹:**

```
Ï„ = Y(q, dq, ddq) * Î¸_base

å…¶ä¸­:
- Ï„: åŠ›çŸ©å‘é‡ (n_samples Ã— n_joints)
- Y: å›å½’çŸ©é˜µ (n_samples Ã— n_params)
- Î¸_base: åŸºå‚æ•°å‘é‡ (n_params Ã— 1)

æœ€å°äºŒä¹˜è§£:
Î¸_base = (Y^T * Y)^(-1) * Y^T * Ï„
```

**ç®€åŒ–çš„å›å½’çŸ©é˜µ:**

å½“å‰å®ç°ä½¿ç”¨ç®€åŒ–çš„å›å½’çŸ©é˜µï¼ˆæ¯ä¸ªå…³èŠ‚5ä¸ªå‚æ•°ï¼‰:
1. æƒ¯æ€§é¡¹: `I * ddq`
2. ç²˜æ€§æ‘©æ“¦: `b * dq`
3. åº“ä¼¦æ‘©æ“¦: `sign(dq)`
4. é‡åŠ›é¡¹ (sin): `g * sin(q)`
5. é‡åŠ›é¡¹ (cos): `g * cos(q)`

**æ³¨æ„:** å®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨å®Œæ•´çš„åŠ¨åŠ›å­¦å›å½’çŸ©é˜µï¼ˆåŸºäº URDF æ¨¡å‹ï¼‰ã€‚

---

### 3. Step 3: éªŒè¯ (`step3_validation.py`)

**å¯¹åº”åŸé¡¹ç›®:** Validation æµç¨‹

**å®ç°çš„æ ¸å¿ƒåŠŸèƒ½:**

| åŠŸèƒ½ | åŸé¡¹ç›® (MATLAB) | æœ¬å®ç° (Python) | çŠ¶æ€ |
|------|----------------|----------------|------|
| åœ¨æ–°è½¨è¿¹ä¸Šæµ‹è¯• | âœ“ | `validate_on_trajectory()` | âœ… |
| é¢„æµ‹ vs æµ‹é‡å¯¹æ¯” | âœ“ | `plot_validation_comparison()` | âœ… |
| ç”ŸæˆéªŒè¯æŠ¥å‘Š | âœ“ | `generate_validation_report()` | âœ… |
| æ€§èƒ½å¯è§†åŒ– | MATLAB plots | Matplotlib plots | âœ… |

**éªŒè¯æŒ‡æ ‡:**

- RMSE (å‡æ–¹æ ¹è¯¯å·®)
- MAE (å¹³å‡ç»å¯¹è¯¯å·®)
- Max Error (æœ€å¤§è¯¯å·®)
- RÂ² Score (å†³å®šç³»æ•°)

---

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
åŸå§‹æ—¥å¿—æ•°æ®
    â”‚
    â”œâ”€ motor_states.csv (q, dq, tau)
    â””â”€ joint_commands.csv
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æ•°æ®é¢„å¤„ç†                   â”‚
â”‚ (filterData.m)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è¯»å–åŸå§‹æ•°æ®                      â”‚
â”‚ 2. é›¶ç›¸ä½æ»¤æ³¢ (ä½ç½®ã€é€Ÿåº¦ã€åŠ›çŸ©)      â”‚
â”‚ 3. ä¸­å¿ƒå·®åˆ†æ³•ä¼°è®¡åŠ é€Ÿåº¦               â”‚
â”‚ 4. æ»¤æ³¢åŠ é€Ÿåº¦                        â”‚
â”‚ 5. ä¿å­˜å¤„ç†åçš„æ•°æ®                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
processed_data/
    â”œâ”€ 20251010_133145_ic_arm_control_filtered.csv
    â””â”€ 20251010_132725_ic_arm_control_filtered.csv
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: å‚æ•°ä¼°è®¡                     â”‚
â”‚ (ordinaryLeastSquareEstimation)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. åŠ è½½é¢„å¤„ç†æ•°æ®                    â”‚
â”‚ 2. æ„å»ºå›å½’çŸ©é˜µ Y(q, dq, ddq)       â”‚
â”‚ 3. æœ€å°äºŒä¹˜æ±‚è§£ Î¸_base              â”‚
â”‚ 4. é¢„æµ‹åŠ›çŸ©å¹¶è¯„ä¼°æ€§èƒ½                â”‚
â”‚ 5. ä¿å­˜ä¼°è®¡å‚æ•°                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
estimation_results/
    â”œâ”€ estimated_parameters.npz
    â””â”€ prediction_results.png
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: éªŒè¯                         â”‚
â”‚ (Validation)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. åŠ è½½ä¼°è®¡å‚æ•°                      â”‚
â”‚ 2. åœ¨éªŒè¯è½¨è¿¹ä¸Šæµ‹è¯•                  â”‚
â”‚ 3. é¢„æµ‹ vs æµ‹é‡å¯¹æ¯”                  â”‚
â”‚ 4. ç”ŸæˆéªŒè¯æŠ¥å‘Š                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
validation_results/
    â”œâ”€ validation_report.txt
    â””â”€ *_validation.png
```

---

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

### 1. é›¶ç›¸ä½æ»¤æ³¢çš„é‡è¦æ€§

**ä¸ºä»€ä¹ˆä½¿ç”¨ `filtfilt` è€Œä¸æ˜¯ `filter`?**

```python
# æ™®é€šæ»¤æ³¢ - å¼•å…¥ç›¸ä½å»¶è¿Ÿ
y_delayed = filter(b, a, x)

# é›¶ç›¸ä½æ»¤æ³¢ - æ— ç›¸ä½å»¶è¿Ÿ
y_no_delay = filtfilt(b, a, x)
```

**åŸç†:** `filtfilt` å…ˆå‰å‘æ»¤æ³¢ï¼Œå†åå‘æ»¤æ³¢ï¼ŒæŠµæ¶ˆç›¸ä½å»¶è¿Ÿã€‚

**é‡è¦æ€§:** 
- ä¿æŒä¿¡å·çš„æ—¶é—´å¯¹é½
- é¿å…å› ç›¸ä½å»¶è¿Ÿå¯¼è‡´çš„å‚æ•°ä¼°è®¡åå·®
- ç‰¹åˆ«é‡è¦å¯¹äºåŠ›çŸ©ä¿¡å·ï¼ˆé€šå¸¸å™ªå£°å¤§ï¼‰

### 2. ä¸­å¿ƒå·®åˆ†æ³• vs å‰å‘å·®åˆ†

```python
# å‰å‘å·®åˆ† (ä¸å‡†ç¡®)
ddq_forward = (dq[i+1] - dq[i]) / dt

# ä¸­å¿ƒå·®åˆ† (æ›´å‡†ç¡®)
ddq_central = (dq[i+1] - dq[i-1]) / (2*dt)
```

**ä¼˜åŠ¿:**
- ä¸­å¿ƒå·®åˆ†çš„æˆªæ–­è¯¯å·®ä¸º O(dtÂ²)
- å‰å‘å·®åˆ†çš„æˆªæ–­è¯¯å·®ä¸º O(dt)
- æ›´å‡†ç¡®çš„åŠ é€Ÿåº¦ä¼°è®¡

### 3. æ¡ä»¶æ•°çš„æ„ä¹‰

```python
cond_number = np.linalg.cond(Y)
```

**ç‰©ç†æ„ä¹‰:**
- æ¡ä»¶æ•°è¡¡é‡å›å½’çŸ©é˜µçš„æ•°å€¼ç¨³å®šæ€§
- æ¡ä»¶æ•°è¶Šå°ï¼Œå‚æ•°ä¼°è®¡è¶Šå‡†ç¡®
- æ¡ä»¶æ•° > 1e10 è¡¨ç¤ºæ¥è¿‘å¥‡å¼‚ï¼Œéœ€è¦æ”¹è¿›æ•°æ®

**æ”¹è¿›æ–¹æ³•:**
- è½¨è¿¹ä¼˜åŒ–ï¼ˆæœ€å°åŒ–æ¡ä»¶æ•°ï¼‰
- æ”¶é›†æ›´å¤šæ ·åŒ–çš„æ•°æ®
- ä½¿ç”¨æ­£åˆ™åŒ–æ–¹æ³•

---

## ğŸ¨ ä¸åŸé¡¹ç›®çš„å®Œå…¨å¯¹åº”

| åŸé¡¹ç›®æ–‡ä»¶ | æœ¬å®ç°æ–‡ä»¶ | å¯¹åº”å…³ç³» |
|-----------|-----------|---------|
| `filterData.m` | `step1_data_preprocessing.py` | 100% å¯¹åº” |
| `ordinaryLeastSquareEstimation` | `step2_parameter_estimation.py::ordinary_least_squares()` | 100% å¯¹åº” |
| `ur_idntfcn_real.m` | `step2_parameter_estimation.py` | ä¸»æµç¨‹å¯¹åº” |
| Validation | `step3_validation.py` | 100% å¯¹åº” |
| `experiment_design.m` | âŒ æœªå®ç° | è½¨è¿¹ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰ |
| `estimate_drive_gains` | âŒ æœªå®ç° | é©±åŠ¨å¢ç›Šä¼°è®¡ï¼ˆå¯é€‰ï¼‰ |
| SDP with constraints | âŒ æœªå®ç° | ç‰©ç†å¯è¡Œæ€§çº¦æŸï¼ˆå¯é€‰ï¼‰ |

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### è¯„ä¼°æŒ‡æ ‡å®šä¹‰

1. **RMSE (Root Mean Square Error)**
   ```
   RMSE = sqrt(mean((Ï„_measured - Ï„_predicted)Â²))
   ```

2. **MAE (Mean Absolute Error)**
   ```
   MAE = mean(|Ï„_measured - Ï„_predicted|)
   ```

3. **RÂ² Score (Coefficient of Determination)**
   ```
   RÂ² = 1 - (SS_res / SS_tot)
   å…¶ä¸­:
   SS_res = Î£(Ï„_measured - Ï„_predicted)Â²
   SS_tot = Î£(Ï„_measured - mean(Ï„_measured))Â²
   ```

4. **Max Error**
   ```
   Max Error = max(|Ï„_measured - Ï„_predicted|)
   ```

### æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ä¼˜ç§€ | è‰¯å¥½ | å¯æ¥å— | éœ€æ”¹è¿› |
|------|------|------|--------|--------|
| å¹³å‡ RMSE | < 0.5 Nm | < 1.0 Nm | < 2.0 Nm | > 2.0 Nm |
| å¹³å‡ RÂ² | > 0.95 | > 0.90 | > 0.80 | < 0.80 |

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹

```bash
# 1. æ£€æŸ¥ç¯å¢ƒ
python quick_test.py

# 2. è¿è¡Œå®Œæ•´æµç¨‹
python run_identification.py

# 3. æˆ–åˆ†æ­¥è¿è¡Œ
python step1_data_preprocessing.py
python step2_parameter_estimation.py
python step3_validation.py
```

### å‚æ•°è°ƒæ•´

**æ»¤æ³¢å™¨å‚æ•° (step1_data_preprocessing.py):**
```python
preprocessor = DataPreprocessor(
    cutoff_freq=10.0,  # é™ä½å¯ä»¥æ›´å¹³æ»‘ï¼Œä½†ä¸¢å¤±é«˜é¢‘ä¿¡æ¯
    fs=250.0,          # é‡‡æ ·é¢‘ç‡
    filter_order=4     # å¢åŠ å¯ä»¥æ›´é™¡å³­çš„æ»¤æ³¢
)
```

**æ•°æ®é€‰æ‹©:**
```python
# åœ¨ step1_data_preprocessing.py ä¸­ä¿®æ”¹
log_dirs = [
    "/path/to/log1",
    "/path/to/log2",
]
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1: æ¡ä»¶æ•°è¿‡å¤§

**ç—‡çŠ¶:** `æ¡ä»¶æ•°: 1.23e+12`

**åŸå› :**
- æ•°æ®ç¼ºä¹å¤šæ ·æ€§
- è½¨è¿¹æœªå……åˆ†æ¿€åŠ±æ‰€æœ‰å‚æ•°

**è§£å†³:**
1. æ”¶é›†æ›´å¤šæ ·åŒ–çš„è½¨è¿¹
2. ä½¿ç”¨è½¨è¿¹ä¼˜åŒ–ç”Ÿæˆæ¿€åŠ±è½¨è¿¹
3. æ£€æŸ¥æ˜¯å¦æœ‰å†—ä½™å‚æ•°

### é—®é¢˜2: é¢„æµ‹ç²¾åº¦ä½

**ç—‡çŠ¶:** `å¹³å‡ RMSE > 5.0 Nm`

**åŸå› :**
- æ»¤æ³¢å™¨å‚æ•°ä¸åˆé€‚
- å›å½’çŸ©é˜µä¸å®Œæ•´
- æ•°æ®è´¨é‡å·®

**è§£å†³:**
1. è°ƒæ•´æˆªæ­¢é¢‘ç‡ (`cutoff_freq`)
2. ä½¿ç”¨å®Œæ•´çš„åŠ¨åŠ›å­¦å›å½’çŸ©é˜µ
3. æ£€æŸ¥ä¼ æ„Ÿå™¨æ ‡å®š

### é—®é¢˜3: æ•°æ®é•¿åº¦ä¸ä¸€è‡´

**ç—‡çŠ¶:** `ValueError: shapes not aligned`

**åŸå› :**
- motor_states.csv å’Œ joint_commands.csv é•¿åº¦ä¸åŒ

**è§£å†³:**
- ä»£ç å·²è‡ªåŠ¨å¤„ç†ï¼ˆå–æœ€å°é•¿åº¦ï¼‰
- æ£€æŸ¥æ•°æ®è®°å½•æ˜¯å¦æ­£å¸¸

---

## ğŸ“š ä¸‹ä¸€æ­¥æ”¹è¿›

### é«˜ä¼˜å…ˆçº§

1. **å®Œæ•´çš„å›å½’çŸ©é˜µ**
   - åŸºäº URDF æ¨¡å‹ç”Ÿæˆ
   - åŒ…å«æ‰€æœ‰åŠ¨åŠ›å­¦é¡¹ï¼ˆæƒ¯æ€§ã€ç§‘æ°åŠ›ã€ç¦»å¿ƒåŠ›ã€é‡åŠ›ï¼‰

2. **ç‰©ç†å¯è¡Œæ€§çº¦æŸ**
   - å®ç° SDP (Semidefinite Programming)
   - ç¡®ä¿å‚æ•°ç‰©ç†æ„ä¹‰

3. **é©±åŠ¨å¢ç›Šä¼°è®¡**
   - å¦‚æœåªæœ‰ç”µæµæµ‹é‡
   - éœ€è¦é¢å¤–çš„è´Ÿè½½å®éªŒ

### ä¸­ä¼˜å…ˆçº§

4. **è½¨è¿¹ä¼˜åŒ–**
   - æœ€å°åŒ–æ¡ä»¶æ•°
   - ç¡®ä¿æŒç»­æ¿€åŠ±

5. **è‡ªåŠ¨å‚æ•°è°ƒæ•´**
   - è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ»¤æ³¢å™¨å‚æ•°
   - äº¤å‰éªŒè¯

### ä½ä¼˜å…ˆçº§

6. **GUI ç•Œé¢**
7. **å®æ—¶å‚æ•°æ›´æ–°**
8. **å¤šæœºå™¨äººæ”¯æŒ**

---

## âœ… éªŒæ”¶æ ‡å‡†

æœ¬å®ç°æ»¡è¶³ä»¥ä¸‹è¦æ±‚:

- [x] ä¸¥æ ¼éµå¾ª `shamilmamedov/dynamic_calibration` çš„é€»è¾‘
- [x] å®ç°é›¶ç›¸ä½æ»¤æ³¢ (`filtfilt`)
- [x] å®ç°ä¸­å¿ƒå·®åˆ†æ³•ä¼°è®¡åŠ é€Ÿåº¦
- [x] å®ç°æ™®é€šæœ€å°äºŒä¹˜ä¼°è®¡
- [x] å®ç°å®Œæ•´çš„éªŒè¯æµç¨‹
- [x] ç”Ÿæˆè¯¦ç»†çš„æ€§èƒ½æŠ¥å‘Š
- [x] å¯è§†åŒ–é¢„æµ‹ç»“æœ
- [x] ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•
- [x] è¯¦ç»†çš„æ–‡æ¡£å’Œæ³¨é‡Š

---

**å®ç°æ—¥æœŸ:** 2025-10-10  
**å®ç°è€…:** IC ARM Control Team  
**ç‰ˆæœ¬:** 1.0.0  
**å‚è€ƒ:** [shamilmamedov/dynamic_calibration](https://github.com/shamilmamedov/dynamic_calibration)
